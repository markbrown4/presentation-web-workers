<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Working Off the Main Thread</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article>
      <section>
        <h1><span>Working Off the </span><strong>Main Thread</strong></h1>
      </section>
      <section style="background-image: url(images/henrik.jpg)" class="bg">
        <div class="pad-lg">
          <p><strong>@henrikjoreteg</strong></p>
          <h1>Pocket-sized JS</h1>
          <p>dotJS 2015</p>
        </div>
      </section>
      <section class="yellow-bg">
        <h1>How to approach the Mobile Web</h1>
      </section>
      <section class="yellow-bg">
        <h1>Actually test on mobile devices</h1>
        <p>If you want to write fast software use a slow computer</p>
      </section>
      <section class="yellow-bg">
        <h1>Send HTML</h1>
        <pre><code class="language-html">&lt;!doctype html&gt;
&lt;script src="app.js"&gt;&lt;/script&gt;
</code></pre>
      </section>
      <section class="yellow-bg">
        <h1>Ship less code</h1>
        <p>Google+ &lt; 60kb JS<br>Soundslice ~94kb JS</p>
        <p>It may be hard but it's not impossible</p>
      </section>
      <section class="yellow-bg">
        <h4 style="font-size: 120px">WEBWORKERS!</h4>
        <p class="animate-up">Even really old android phones have multiple cores</p>
      </section>
      <section style="background-image: url(images/pokedex.png)" class="bg-plain"></section>
      <section class="yellow-bg">
        <blockquote>
          <p><span>&ldquo;</span>Ask any iOS or Android developer how we make our apps so fast,<br>and most likely you'll hear about two major strategies<span>&rdquo;</span></p>
          <p><strong>Eliminate network calls</strong><br><strong>Use background threads</strong></p>
        </blockquote>
      </section>
      <section class="yellow-bg">
        <blockquote>
          <h1 style="margin: 2em 0"><span>&ldquo;</span>Anything unrelated to the UI should be<br>offloaded to a background thread.<span>&rdquo;</span></h1>
          <p class="animate-up">Working in the Main Thread should be the exception</p>
        </blockquote>
      </section>
      <section class="yellow-bg">
        <h1>feather-app</h1>
        <p>~8.5kb JS</p>
        <p>http://feather.surge.sh</p>
      </section>
      <section class="yellow-bg">
        <h1>The Main Thread has 3 responsibilities</h1>
        <p>sending "state of the world" to worker on start<br>listening for and sending serializable actions back to the worker<br>applying DOM patches when received from worker</p>
      </section>
      <section>
        <h1>worker.thread.js</h1>
        <pre><code class="language-javascript">import diff from 'virtual-dom/diff'
import serializePatch from 'vdom-serialized-patch/serialize'
import fromJson from 'vdom-as-json/fromJson'
import app from './views/app'

let currentVDom
const state = {
  count: 0,
  url: '/'
}

self.onmessage = ({data}) =&gt; {
  const { type, payload } = data
  
  switch (type) {
    case 'start': {
      currentVDom = fromJson(payload.virtualDom)
      state.url = payload.url
      break
    }
    case 'setUrl': {
      state.url = payload
      break
    }
    case 'increment': {
      state.count++
      break
    }
    case 'decrement': {
      state.count--
      break
    }
  }
  
  const newVDom = app(state)
  const patches = diff(currentVDom, newVDom)
  currentVDom = newVDom
  
  self.postMessage({url: state.url, payload: serializePatch(patches)})
}
</code></pre>
      </section>
      <section>
        <h1>main.js</h1>
        <pre><code class="language-javascript">import WorkerThread from './worker.thread'
import virtualize from 'vdom-virtualize'
import toJson from 'vdom-as-json/toJson'
import applyPatch from 'vdom-serialized-patch/patch'
import { getLocalPathname } from 'local-links'

// webpack's worker-loader
const worker = new WorkerThread()
const rootElement = document.body.firstChild

worker.onmessage = ({data}) =&gt; {
  const { url, payload } = data
  requestAnimationFrame(() =&gt; {
    applyPatch(rootElement, payload)
  })
  
  if (location.pathname !== url) {
    history.pushState(null, null, url)
  }
}

// init virtual-dom with server-rendered html
worker.postMessage({type: 'start', payload: {
  virtualDom: toJson(virtualize(rootElement)),
  url: location.pathname
}})

// Support back/forward buttons
window.addEventListener('popstate', () =&gt; {
  worker.postMessage({type: 'setUrl', payload: location.pathname})
})

// listen for all events globally
document.body.addEventListener('click', (event) =&gt; {

  const pathname = getLocalPathname(event)
  if (pathname) {
    event.preventDefault()
    
    worker.postMessage({type: 'setUrl', payload: pathname})
    return
  }
  
  const click = event.target['data-click']
  if (click) {
    event.preventDefault()
    worker.postMessage(click)
  }
})
</code></pre>
      </section>
      <section>
        <h1>app.js</h1>
        <pre><code class="language-javascript">import home from './home'
import about from './about'

export default (state) =&gt; {
  const { url } = state
  let page
  
  if (url === '/') {
    page = home(state)
  } else if (url === '/about') {
    page = about()
  }
  
  return (
    &lt;main&gt;
      &lt;h1&gt;Feather POC App&lt;/h1&gt;
      &lt;nav&gt;
        &lt;a href='/'&gt;home&lt;/a&gt; | &lt;a href='/about'&gt;about&lt;/a&gt;
      &lt;/nav&gt;
      {page}
    &lt;/main&gt;
  )
}
</code></pre>
      </section>
      <section>
        <h1>home.js</h1>
        <pre><code class="language-javascript">export default ({count}) =&gt; (
  &lt;div&gt;
    &lt;p&gt;This app weighs about 8.5kb&lt;/p&gt;
    &lt;button data-click={{type: 'decrement'}}&gt; - &lt;/button&gt;
    &lt;span&gt; {count} &lt;/span&gt;
    &lt;button data-click={{type: 'increment'}}&gt; + &lt;/button&gt;
  &lt;/div&gt;
)

</code></pre>
      </section>
      <section class="yellow-bg">
        <h1 style="margin: 2em 0">How to approach the <span style="text-decoration: line-through">Mobile</span> Web</h1>
        <div class="animate-up">
          <p>https://github.com/reactjs/react-future</p>
          <p>Angular 2 team are all over it</p>
        </div>
      </section>
      <section>
        <h1>Thanks</h1>
        <p>@markbrown4</p><img src="images/i9dev-logo.svg" width="150">
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>